angular.module("afkl.lazyImage",[]),angular.module("afkl.lazyImage").service("afklSrcSetService",["$window",function(e){"use strict";function n(e){this.src=e.src,this.w=e.w||1/0,this.h=e.h||1/0,this.x=e.x||1}var t=/^[0-9]+$/,r=function(e){for(var n=e.split(/\s/),r={},a=0,i=n.length;i>a;a++){var o=n[a];if(o.length>0){var c=o.slice(-1),u=o.substring(0,o.length-1),l=parseInt(u,10),f=parseFloat(u);u.match(t)&&"w"===c?r[c]=l:u.match(t)&&"h"===c?r[c]=l:isNaN(f)||"x"!==c||(r[c]=f)}}return r},a=function(e,n){for(var t=e[0],r=0,a=e.length;a>r;r++){var i=e[r];n(i,t)&&(t=i)}return t},i=function(e,n){for(var t=e.length-1;t>=0;t--){var r=e[t];n(r)&&e.splice(t,1)}return e},o=function(n,t){if(n){t||(t={w:e.innerWidth||document.documentElement.clientWidth,h:e.innerHeight||document.documentElement.clientHeight,x:e.devicePixelRatio||1});var r=n.slice(0),o=a(r,function(e,n){return e.w>n.w});i(r,function(){return function(e){return e.w<t.w}}(this)),0===r.length&&(r=[o]);var c=a(r,function(e,n){return e.h>n.h});i(r,function(){return function(e){return e.h<t.h}}(this)),0===r.length&&(r=[c]);var u=a(r,function(e,n){return e.x>n.x});i(r,function(){return function(e){return e.x<t.x}}(this)),0===r.length&&(r=[u]);var l=a(r,function(e,n){return e.w<n.w});i(r,function(e){return e.w>l.w});var f=a(r,function(e,n){return e.h<n.h});i(r,function(e){return e.h>f.h});var s=a(r,function(e,n){return e.x<n.x});return i(r,function(e){return e.x>s.x}),r[0]}},c=function(e){var t=[],a=e.src,i=e.srcset;if(i){var c=function(e){for(var n=0,r=t.length;r>n;n++){var a=t[n];if(a.x===e.x&&a.w===e.w&&a.h===e.h)return}t.push(e)},u=function(){for(var e,t,o=i,u=0,l=[];""!==o;){for(;" "===o.charAt(0);)o=o.slice(1);u=o.indexOf(" "),-1!==u?(e=o.slice(0,u),o=o.slice(u+1),u=o.indexOf(","),-1===u?(t=o,o=""):(t=o.slice(0,u),o=o.slice(u+1)),l.push({url:e,descriptors:t})):(l.push({url:o,descriptors:""}),o="")}for(var f=0,s=l.length;s>f;f++){var g=l[f],d=r(g.descriptors);c(new n({src:g.url,x:d.x,w:d.w,h:d.h}))}a&&c(new n({src:a}))};u();var l=o(t),f={best:l,candidates:t};return t=null,f}};return{get:c,image:o}}]),angular.module("afkl.lazyImage").directive("afklImageContainer",function(){"use strict";return{restrict:"A",controller:["$scope","$element",function(e,n){n.data("afklImageContainer",n)}]}}).directive("afklLazyImage",["$window","$timeout","afklSrcSetService","$parse",function(e,n,t,r){"use strict";var a=function(e){var n,r=t.get({srcset:e});return r&&(n=r.best.src),n};return{restrict:"A",link:function(t,i,o){var c=i.inheritedData("afklImageContainer");c||(c=angular.element(o.afklLazyImageContainer||e));var u,l,f=!1,s=o.afklLazyImage,g=o.afklLazyImageOptions?r(o.afklLazyImageOptions)(t):{},d=null,h=g.offset?g.offset:50,m=g.alt?'alt="'+g.alt+'"':'alt=""',v="afkl-lazy-image-loading",p="afkl-lazy-image";g.className&&(p=p+" "+g.className),o.afklLazyImageLoaded=!1;var k=function(){if(c.scrollTop){var e=c.scrollTop();if(e)return e}var n=c[0];return void 0!==n.pageYOffset?n.pageYOffset:void 0!==n.scrollTop?n.scrollTop:document.documentElement.scrollTop||0},w=function(){if(c.innerHeight)return c.innerHeight();var e=c[0];return void 0!==e.innerHeight?e.innerHeight:void 0!==e.clientHeight?e.clientHeight:document.documentElement.clientHeight||0},z=function(){if(i.offset)return i.offset().top;var e=i[0].getBoundingClientRect();return e.top+k()-document.documentElement.clientTop},x=function(){return i.offset?i.offset().top-c.offset().top:i[0].getBoundingClientRect().top-c[0].getBoundingClientRect().top},y=function(){g.background?i[0].style.backgroundImage='url("'+d+'")':l[0].src=d},I=function(){f=!0;var e=a(s);e&&(g.background||l||(l=angular.element("<img "+m+' class="'+p+'" src=""/>'),i.append(l)),L()),c.off("scroll",H)},L=function(){if(f){var e=a(s);e!==d&&(d=e,g.background||(i.addClass(v),l.one("load",$),l.one("error",C)),y())}};L();var $=function(){o.$set("afklLazyImageLoaded","done"),i.removeClass(v)},C=function(){o.$set("afklLazyImageLoaded","fail")},H=function(){var n,t,r,a=w(),i=k(),o=c[0]===e?z():x();r=c[0]===e?a+i:a,n=o-r,t=h>=n,t&&!f&&I()},b=function(){n.cancel(u),u=n(function(){L(),H()},300)},O=function(){n.cancel(u),c.off("scroll",H),angular.element(e).off("resize",b),c[0]!==e&&c.off("resize",b),l&&l.remove(),l=u=d=void 0};return c.on("scroll",H),angular.element(e).on("resize",b),c[0]!==e&&c.on("resize",b),o.$observe("afklLazyImage",function(){s=o.afklLazyImage,f&&I()}),g.nolazy&&I(),t.$on("$destroy",function(){return O()}),H()}}}]);